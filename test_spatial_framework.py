#!/usr/bin/env python3
"""测试空间框架功能

测试空间框架的构建功能，包括层级化的空间关系、事件与地点的关联关系等。
"""

import json
import logging
from datetime import datetime

from json2graph import Neo4jConnection, SKGStore, SpatialRelationshipProcessor, SpatialProcessor
from json2graph.interfaces import EntityType

# 配置日志
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)


def create_test_data():
    """创建测试数据"""
    test_data = {
"基础实体": [
    {
      "类型": "事件",
      "名称": "2020年6月上旬桂北、桂西地区暴雨洪涝灾害过程",
      "唯一ID": "E-450000-20200529-FLOOD",
      "地理描述": "广西桂北、桂西地区"
    },
    {
      "类型": "地点",
      "名称": "桂林市",
      "唯一ID": "L-450300",
      "地理描述": "广西壮族自治区桂林市"
    },
    {
      "类型": "地点",
      "名称": "广西",
      "唯一ID": "L-450000",
      "地理描述": "广西壮族自治区"
    },
    {
      "类型": "地点",
      "名称": "柳州市",
      "唯一ID": "L-450200",
      "地理描述": "广西壮族自治区柳州市"
    },
    {
      "类型": "地点",
      "名称": "河池市",
      "唯一ID": "L-451200",
      "地理描述": "广西壮族自治区河池市"
    },
    {
      "类型": "地点",
      "名称": "百色市",
      "唯一ID": "L-451000",
      "地理描述": "广西壮族自治区百色市"
    },
    {
      "类型": "地点",
      "名称": "临桂区",
      "唯一ID": "L-450312",
      "地理描述": "广西壮族自治区桂林市雁山区"
    },
    {
      "类型": "地点",
      "名称": "永福县",
      "唯一ID": "L-450326",
      "地理描述": "广西壮族自治区桂林市永福县"
    },
    {
      "类型": "地点",
      "名称": "灵川县",
      "唯一ID": "L-450323",
      "地理描述": "广西壮族自治区桂林市灵川县"
    },
    {
      "类型": "地点",
      "名称": "罗城仫佬族自治县",
      "唯一ID": "L-451225",
      "地理描述": "广西壮族自治区河池市罗城县"
    },
    {
      "类型": "地点",
      "名称": "柳城县",
      "唯一ID": "L-450222",
      "地理描述": "广西壮族自治区柳州市柳城县"
    },
    {
      "类型": "地点",
      "名称": "融安县",
      "唯一ID": "L-450224",
      "地理描述": "广西壮族自治区柳州市融安县"
    },
    {
      "类型": "地点",
      "名称": "融水苗族自治县",
      "唯一ID": "L-450225",
      "地理描述": "广西壮族自治区柳州市融水县"
    },
    {
      "类型": "地点",
      "名称": "荔浦市",
      "唯一ID": "L-450381",
      "地理描述": "广西壮族自治区桂林市荔浦市"
    },
    {
      "类型": "地点",
      "名称": "阳朔县",
      "唯一ID": "L-450321",
      "地理描述": "广西壮族自治区桂林市阳朔县"
    },
    {
      "类型": "地点",
      "名称": "堡里镇",
      "唯一ID": "L-450326>堡里镇",
      "地理描述": "广西壮族自治区桂林市永福县"
    },
    {
      "类型": "地点",
      "名称": "宛田乡",
      "唯一ID": "L-450312>宛田乡",
      "地理描述": "广西壮族自治区桂林市临桂区"
    },
    {
      "类型": "地点",
      "名称": "双江镇",
      "唯一ID": "L-450381>双江镇",
      "地理描述": "广西壮族自治区桂林市荔浦市双江镇"
    },
    {
      "类型": "地点",
      "名称": "高田镇",
      "唯一ID": "L-450321>高田镇",
      "地理描述": "广西壮族自治区桂林市阳朔县"
    },
    {
      "类型": "设施",
      "名称": "金鸡河水库",
      "唯一ID": "F-450326-金鸡河水库",
      "地理描述": "广西桂林市永福县罗锦镇金鸡河水库"
    },
    {
      "类型": "地点",
      "名称": "柳江",
      "唯一ID": "L-RIVER-柳江",
      "地理描述": "广西柳江"
    },
    {
      "类型": "地点",
      "名称": "洛清江",
      "唯一ID": "L-RIVER-洛清江",
      "地理描述": "广西洛清江"
    },
    {
      "类型": "地点",
      "名称": "洛清江",
      "唯一ID": "L-RIVER-洛清江>中下游",
      "地理描述": "广西洛清江中下游"
    },
    {
      "类型": "地点",
      "名称": "洛清江",
      "唯一ID": "L-RIVER-洛清江>永福以下河段",
      "地理描述": "广西洛清江永福以下河段"
    },
    {
      "类型": "地点",
      "名称": "桂江",
      "唯一ID": "L-RIVER-桂江",
      "地理描述": "广西桂江"
    },
    {
      "类型": "地点",
      "名称": "桂江",
      "唯一ID": "L-RIVER-桂江>中下游",
      "地理描述": "广西桂江中下游"
    },
    {
      "类型": "地点",
      "名称": "桂江",
      "唯一ID": "L-RIVER-桂江>阳朔以下河段",
      "地理描述": "广西桂江阳朔以下河段"
    },
    {
      "类型": "地点",
      "名称": "贺江",
      "唯一ID": "L-RIVER-贺江",
      "地理描述": "广西贺江"
    },
    {
      "类型": "地点",
      "名称": "西江",
      "唯一ID": "L-RIVER-西江",
      "地理描述": "广西西江"
    },
    {
      "类型": "地点",
      "名称": "西江",
      "唯一ID": "L-RIVER-西江>中下游",
      "地理描述": "广西西江"
    },
    {
      "类型": "地点",
      "名称": "马岭河",
      "唯一ID": "L-RIVER-马岭河",
      "地理描述": "广西桂江支流马岭河"
    },
    {
      "类型": "地点",
      "名称": "东小江",
      "唯一ID": "L-RIVER-东小江",
      "地理描述": "广西龙江支流东小江"
    },
    {
      "类型": "地点",
      "名称": "灵奇河",
      "唯一ID": "L-RIVER-灵奇河",
      "地理描述": "广西红水河支流灵奇河"
    },
    {
      "类型": "地点",
      "名称": "良丰河",
      "唯一ID": "L-RIVER-良丰河",
      "地理描述": "广西桂江支流良丰河"
    },
    {
      "类型": "地点",
      "名称": "富川瑶族自治县",
      "唯一ID": "L-451123",
      "地理描述": "广西壮族自治区贺州市富川县"
    },
    {
      "类型": "设施",
      "名称": "富阳水文站",
      "唯一ID": "F-451123-富阳水文站",
      "地理描述": "广西贺州市富阳水文站"
    },
    {
      "类型": "设施",
      "名称": "鹿寨水文站",
      "唯一ID": "F-450223-鹿寨水文站",
      "地理描述": "广西柳州市鹿寨水文站"
    },
    {
      "类型": "设施",
      "名称": "黄冕水文站",
      "唯一ID": "F-450223-黄冕水文站",
      "地理描述": "广西柳州市黄冕水文站"
    },
    {
      "类型": "设施",
      "名称": "平乐水文站",
      "唯一ID": "F-450330-平乐水文站",
      "地理描述": "广西桂林市平乐县平乐水文站"
    }
  ],
  "状态实体": [
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "E-450000-20200529-FLOOD"
      ],
      "状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "持续时间": "12天",
        "强降雨区": "桂北、桂西地区",
        "特点": "持续时间长、累积雨量大；强降雨区高度重叠；局地强度大、多地破记录"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450000"
      ],
      "状态ID": "LS-L-450000-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "降雨范围": "全区",
        "超过300毫米_乡镇数量": "299个",
        "200-300毫米_乡镇数量": "261个",
        "100-200毫米_乡镇数量": "324个",
        "50-100毫米_乡镇数量": "238个"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450222"
      ],
      "状态ID": "LS-L-450222-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "累积雨量": "超过800毫米"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450224"
      ],
      "状态ID": "LS-L-450224-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "累积雨量": "超过800毫米"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450225"
      ],
      "状态ID": "LS-L-450225-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "累积雨量": "超过800毫米"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450312"
      ],
      "状态ID": "LS-L-450312-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "累积雨量": "超过800毫米"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450323"
      ],
      "状态ID": "LS-L-450323-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "累积雨量": "超过800毫米"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450326"
      ],
      "状态ID": "LS-L-450326-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "累积雨量": "超过800毫米"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-451225"
      ],
      "状态ID": "LS-L-451225-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "累积雨量": "超过800毫米"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450321"
      ],
      "状态ID": "LS-L-450321-20200607_20200607",
      "时间": "2020-06-07至2020-06-07",
      "状态描述": {
        "日降雨量": "327.7毫米",
        "记录": "打破当地历史记录"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450326>堡里镇"
      ],
      "状态ID": "LS-L-450326>堡里镇-20200606_20200607",
      "时间": "2020-06-06至2020-06-07",
      "状态描述": {
        "雨量": "396毫米",
        "时间": "6日19时至7日19时",
        "重现期": "超百年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450312>宛田乡"
      ],
      "状态ID": "LS-L-450312>宛田乡-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "雨量": "861.7毫米"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450381>双江镇"
      ],
      "状态ID": "LS-L-450381>双江镇-20200606_20200607",
      "时间": "2020-06-06至2020-06-07",
      "状态描述": {
        "雨量": "456毫米",
        "时间": "6月6日18时至7日18时",
        "重现期": "超百年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450321>高田镇"
      ],
      "状态ID": "LS-L-450321>高田镇-20200606_20200607",
      "时间": "2020-06-06至2020-06-07",
      "状态描述": {
        "雨量": "434毫米",
        "时间": "6月6日18时至7日18时"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "F-450326-金鸡河水库"
      ],
      "状态ID": "FS-F-450326-金鸡河水库-20200607_20200607",
      "时间": "2020-06-07至2020-06-07",
      "状态描述": {
        "3小时雨量": "232.1毫米",
        "记录": "破历史记录"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-柳江"
      ],
      "状态ID": "LS-L-RIVER-柳江-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "水位状态": "超警"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-西江>中下游"
      ],
      "状态ID": "LS-L-RIVER-西江>中下游-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "水位状态": "超警"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-洛清江"
      ],
      "状态ID": "LS-L-RIVER-洛清江-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "水位状态": "超警",
        "洪水级别": "10到20年一遇",
        "鹿寨水文站记录": "2010年建站以来第1大洪水",
        "黄冕水文站记录": "建站以来第2大洪水,20年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-洛清江>永福以下河段"
      ],
      "状态ID": "LS-L-RIVER-洛清江>永福以下河段-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "水位状态": "全线超警"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-洛清江>中下游"
      ],
      "状态ID": "LS-L-RIVER-洛清江>中下游-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "洪水级别": "10到20年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-桂江"
      ],
      "状态ID": "LS-L-RIVER-桂江-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "水位状态": "全线超警"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-桂江>中下游"
      ],
      "状态ID": "LS-L-RIVER-桂江>中下游-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "洪水级别": "10到20年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-桂江>阳朔以下河段"
      ],
      "状态ID": "LS-L-RIVER-桂江>阳朔以下河段-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "水位状态": "全线超警"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-贺江"
      ],
      "状态ID": "LS-L-RIVER-贺江-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "水位状态": "超警",
        "富阳水文站记录": "建站以来第2大洪水,接近50年一遇大洪水"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-西江"
      ],
      "状态ID": "LS-L-RIVER-西江-20200609_20200609",
      "时间": "2020-06-09至2020-06-09",
      "状态描述": {
        "洪水编号": "今年第1号",
        "最高水位": "20.72米",
        "相应流量": "34900立方米每秒",
        "超警历时": "6天"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-马岭河"
      ],
      "状态ID": "LS-L-RIVER-马岭河-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "洪水级别": "50年一遇特大洪水"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-东小江"
      ],
      "状态ID": "LS-L-RIVER-东小江-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "洪水级别": "5-20年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-灵奇河"
      ],
      "状态ID": "LS-L-RIVER-灵奇河-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "洪水级别": "5-20年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-RIVER-良丰河"
      ],
      "状态ID": "LS-L-RIVER-良丰河-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "洪水级别": "5-20年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-451123"
      ],
      "状态ID": "LS-L-451123-20200607_20200607",
      "时间": "2020-06-07至2020-06-07",
      "状态描述": {
        "日降雨量": "237毫米",
        "记录": "打破当地历史记录"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "F-451123-富阳水文站"
      ],
      "状态ID": "FS-F-451123-富阳水文站-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "记录": "建站以来第2大洪水",
        "洪水级别": "接近50年一遇大洪水"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "F-450223-鹿寨水文站"
      ],
      "状态ID": "FS-F-450223-鹿寨水文站-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "记录": "2010年建站以来第1大洪水"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "F-450223-黄冕水文站"
      ],
      "状态ID": "FS-F-450223-黄冕水文站-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "记录": "建站以来第2大洪水",
        "洪水级别": "20年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "F-450330-平乐水文站"
      ],
      "状态ID": "FS-F-450330-平乐水文站-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "记录": "建站以来第2大洪水",
        "洪水级别": "接近20年一遇"
      }
    },
    {
      "类型": "独立状态",
      "关联实体ID列表": [
        "L-450000"
      ],
      "状态ID": "LS-L-450000-20200529_20200610",
      "时间": "2020-05-29至2020-06-10",
      "状态描述": {
        "超警河流数量": "57条",
        "超警站点数量": "91个",
        "超警站次": "134站次"
      }
    }
  ],
  "状态关系": [
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450000-20200529_20200610",
      "依据": "受高空槽、切变线等天气系统共同影响，5月29日至6月10日，我区出现连续性强降雨天气过程"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450222-20200529_20200610",
      "依据": "其中临桂、永福、灵川、罗城、柳城、融安、融水累积雨量超过800毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450224-20200529_20200610",
      "依据": "其中临桂、永福、灵川、罗城、柳城、融安、融水累积雨量超过800毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450225-20200529_20200610",
      "依据": "其中临桂、永福、灵川、罗城、柳城、融安、融水累积雨量超过800毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450312-20200529_20200610",
      "依据": "其中临桂、永福、灵川、罗城、柳城、融安、融水累积雨量超过800毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450323-20200529_20200610",
      "依据": "其中临桂、永福、灵川、罗城、柳城、融安、融水累积雨量超过800毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450326-20200529_20200610",
      "依据": "其中临桂、永福、灵川、罗城、柳城、融安、融水累积雨量超过800毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-451225-20200529_20200610",
      "依据": "其中临桂、永福、灵川、罗城、柳城、融安、融水累积雨量超过800毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450312>宛田乡-20200529_20200610",
      "依据": "最大为桂林市临桂区宛田乡861.7毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450321>高田镇-20200606_20200607",
      "依据": "阳朔县高田镇434毫米（6日18时至7日18时）"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450381>双江镇-20200606_20200607",
      "依据": "荔浦市双江镇456毫米（6日18时至7日18时）"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450326>堡里镇-20200606_20200607",
      "依据": "永福县堡里镇396毫米（6日19时至7日19时）"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-450321-20200607_20200607",
      "依据": "6月7日，日降雨量阳朔327.7毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-451123-20200607_20200607",
      "依据": "6月7日，日降雨量富川237毫米"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "FS-F-450326-金鸡河水库-20200607_20200607",
      "依据": "永福县罗锦镇金鸡河水库3小时雨量232.1毫米破历史记录"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-柳江-20200529_20200610",
      "依据": "受强降雨影响，我区出现今年以来持续时间最长、影响范围最广、强度最大的暴雨洪水过程，桂北多条江河反复超警"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-洛清江-20200529_20200610",
      "依据": "受强降雨影响，我区出现今年以来持续时间最长、影响范围最广、强度最大的暴雨洪水过程，桂北多条江河反复超警"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-洛清江>永福以下河段-20200529_20200610",
      "依据": "受强降雨影响，我区出现今年以来持续时间最长、影响范围最广、强度最大的暴雨洪水过程，桂北多条江河反复超警"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-洛清江>中下游-20200529_20200610",
      "依据": "受强降雨影响，我区出现今年以来持续时间最长、影响范围最广、强度最大的暴雨洪水过程，桂北多条江河反复超警"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-桂江-20200529_20200610",
      "依据": "受强降雨影响，我区出现今年以来持续时间最长、影响范围最广、强度最大的暴雨洪水过程，桂北多条江河反复超警"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-桂江>中下游-20200529_20200610",
      "依据": "其中洛清江永福以下河段、贺江、桂江阳朔以下河段全线超警，洛清江、桂江中下游出现10到20年一遇洪水"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-桂江>阳朔以下河段-20200529_20200610",
      "依据": "其中洛清江永福以下河段、贺江、桂江阳朔以下河段全线超警，"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-贺江-20200529_20200610",
      "依据": "受强降雨影响，我区出现今年以来持续时间最长、影响范围最广、强度最大的暴雨洪水过程，桂北多条江河反复超警"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-西江-20200609_20200609",
      "依据": "西江出现今年第1号编号洪水，6月9日4时最高水位20.72米，相应流量34900立方米每秒，超警历时6天。"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-西江>中下游-20200529_20200610",
      "依据": "隐含：基于邻接结构，事件洪水描述后直接列出西江中下游超警（第6句和第7句）"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-马岭河-20200529_20200610",
      "依据": "桂江支流马岭河出现50年一遇特大洪水"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "FS-F-451123-富阳水文站-20200529_20200610",
      "依据": "贺江上游富阳水文站出现建站以来第2大洪水"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "FS-F-450223-鹿寨水文站-20200529_20200610",
      "依据": "洛清江鹿寨水文站出现2010年建站以来第1大洪水"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "FS-F-450223-黄冕水文站-20200529_20200610",
      "依据": "洛清江黄冕水文站出现建站以来第2大洪水"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "FS-F-450330-平乐水文站-20200529_20200610",
      "依据": "桂江平乐水文站出现建站以来第2大洪水"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-东小江-20200529_20200610",
      "依据": "龙江支流东小江、红水河支流灵奇河、桂江支流良丰河等部分中小河流出现5-20年一遇洪水"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-灵奇河-20200529_20200610",
      "依据": "龙江支流东小江、红水河支流灵奇河、桂江支流良丰河等部分中小河流出现5-20年一遇洪水"
    },
    {
      "主体状态ID": "ES-E-450000-20200529-FLOOD-20200529_20200610",
      "关系": "导致",
      "客体状态ID": "LS-L-RIVER-良丰河-20200529_20200610",
      "依据": "龙江支流东小江、红水河支流灵奇河、桂江支流良丰河等部分中小河流出现5-20年一遇洪水"
    }
  ]
    }
    return test_data


def test_spatial_framework():
    """测试空间框架功能"""
    logger.info("开始测试空间框架功能...")

    try:
        # 创建数据库连接
        db_connection = Neo4jConnection(
            uri="bolt://localhost:7687",
            user="neo4j",
            password="admin123456"
        )
        db_connection.connect()
        logger.info("数据库连接成功")

        # 创建存储实例
        store = SKGStore(db_connection)
        logger.info("存储实例创建成功")

        # 添加空间关系处理器
        spatial_Relationship_processor = SpatialRelationshipProcessor()
        # 配置空间处理器
        spatial_config = {
            "api_key": "msvcwRmOJFaHyzjlieIP0Z1TI1PZIvgl",  # 请替换为实际的API密钥
            "service": "baidu",
            "cache_file": "spatial_geocoding_cache.json",
            "admin_geojson_dir": "data/admin_geojson",
            "river_geojson_dir": "data/river_geojson"
        }
        # 添加空间处理器
        spatial_processor = SpatialProcessor(
            **spatial_config
        )
        store.add_processor(spatial_processor)
        store.add_processor(spatial_Relationship_processor)
        logger.info("空间关系处理器添加成功")

        # 获取测试数据
        test_data = create_test_data()
        logger.info(f"测试数据准备完成，包含 {len(test_data['基础实体'])} 个基础实体")

        # 存储数据
        logger.info("开始存储数据...")
        store.store_knowledge_graph(test_data)
        logger.info("数据存储完成")

        # 构建空间框架
        logger.info("开始构建空间框架...")
        spatial_info = store.build_spatial_framework()
        logger.info(f"空间框架构建完成: {spatial_info}")

        # 验证空间关系
        logger.info("开始验证空间关系...")
        verify_spatial_relationships(db_connection)

        logger.info("空间框架测试完成！")
        return True

    except Exception as e:
        logger.error(f"测试失败: {e}")
        return False

    finally:
        if 'db_connection' in locals():
            db_connection.close()


def verify_spatial_relationships(db_connection):
    """验证空间关系是否正确创建"""

    # 验证层级化的空间关系 (locatedIn)
    logger.info("验证层级化的空间关系...")

    query_hierarchy = """
        MATCH (child)-[r:locatedIn]->(parent)
        RETURN child.id AS child_id, child.name AS child_name,
               parent.id AS parent_id, parent.name AS parent_name
        ORDER BY child_id
    """

    with db_connection.get_session() as session:
        hierarchy_results = session.run(query_hierarchy).data()
        logger.info(f"找到 {len(hierarchy_results)} 个层级关系:")
        for rel in hierarchy_results:
            logger.info(f"  {rel['child_name']} ({rel['child_id']}) -[locatedIn]-> {rel['parent_name']} ({rel['parent_id']})")

    # 验证事件与地点的关系 (occurredAt)
    logger.info("验证事件与地点的关系...")

    query_events = """
        MATCH (event)-[r:occurredAt]->(location)
        WHERE event.id STARTS WITH 'E-'
        RETURN event.id AS event_id, event.name AS event_name,
               location.id AS location_id, location.name AS location_name
        ORDER BY event_id
    """

    with db_connection.get_session() as session:
        event_results = session.run(query_events).data()
        logger.info(f"找到 {len(event_results)} 个事件与地点的关系:")
        for rel in event_results:
            logger.info(f"  事件: {rel['event_name']} ({rel['event_id']}) -[occurredAt]-> 地点: {rel['location_name']} ({rel['location_id']})")

    # 验证设施与地点的关系 (locatedIn)
    logger.info("验证设施与地点的关系...")

    query_facilities = """
        MATCH (facility)-[r:locatedIn]->(location)
        WHERE facility.id STARTS WITH 'F-'
        RETURN facility.id AS facility_id, facility.name AS facility_name,
               location.id AS location_id, location.name AS location_name
        ORDER BY facility_id
    """

    with db_connection.get_session() as session:
        facility_results = session.run(query_facilities).data()
        logger.info(f"找到 {len(facility_results)} 个设施与地点的关系:")
        for rel in facility_results:
            logger.info(f"  设施: {rel['facility_name']} ({rel['facility_id']}) -[locatedIn]-> 地点: {rel['location_name']} ({rel['location_id']})")

    # 验证行政区划层级关系
    logger.info("验证行政区划层级关系...")

    query_admin_hierarchy = """
        MATCH (child:地点)-[r:locatedIn]->(parent:地点)
        WHERE child.id STARTS WITH 'L-' AND parent.id STARTS WITH 'L-'
        AND NOT child.id CONTAINS 'RIVER'
        RETURN child.id AS child_id, child.name AS child_name,
               parent.id AS parent_id, parent.name AS parent_name
        ORDER BY child_id
    """

    with db_connection.get_session() as session:
        admin_results = session.run(query_admin_hierarchy).data()
        logger.info(f"找到 {len(admin_results)} 个行政区划层级关系:")
        for rel in admin_results:
            logger.info(f"  行政区划: {rel['child_name']} ({rel['child_id']}) -[locatedIn]-> {rel['parent_name']} ({rel['parent_id']})")

    logger.info("空间关系验证完成")


def test_spatial_processor():
    """测试空间关系处理器"""
    logger.info("开始测试空间关系处理器...")

    # 创建空间关系处理器
    processor = SpatialRelationshipProcessor()

    # 测试基础实体处理
    base_entity = {
        "类型": "地点",
        "名称": "测试地点",
        "唯一ID": "L-450123",
        "地理描述": "测试描述"
    }

    result = processor.process(EntityType.BASE_ENTITY, base_entity)
    logger.info(f"基础实体处理结果: {len(result.graph_operations)} 个图操作")

    # 测试状态实体处理
    state_entity = {
        "类型": "独立状态",
        "关联实体ID列表": ["L-450123", "L-450100"],
        "状态ID": "S-TEST-001",
        "时间": "2024-01-01至2024-01-31",
        "状态描述": {"测试属性": "测试值"}
    }

    result = processor.process(EntityType.STATE_ENTITY, state_entity)
    logger.info(f"状态实体处理结果: {len(result.graph_operations)} 个图操作")

    logger.info("空间关系处理器测试完成")


if __name__ == "__main__":
    logger.info("=== 空间框架功能测试 ===")

    # 测试空间关系处理器
    # test_spatial_processor()

    # 测试完整的框架功能
    success = test_spatial_framework()

    if success:
        logger.info("所有测试通过！")
    else:
        logger.error("测试失败！")
        exit(1)